pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- wavedash
-- input is wayyy too complicated
-- to sanely code in the pico 8
-- ide. also, focused on ground
-- movement way too much before
-- even touching jumping lol
-- nice sprites though c:

function _init()
	local x=0
	local y=0
	for i = 0,64 do
		for j = 0,64 do
			if fget(mget(i,j),7) then
				x=i*8
				y=j*8
				goto create_player
			end
		end
	end
	:: create_player ::
	player_state=0
	player_x=x
	player_y=y
	player_vel_x=0
	player_vel_y=0
	player_acc_x=0
	player_acc_y=0
	player_turned=1
	player_dash=0
	player_stopping=0
	
end

function _update60()
	update_input()
	
	--[[
		player state:
		- 0 = wait
		- 1 = dash
		- 2 = run
		- 3 = run stopping
		- 4 = dash stopping
		- 10= jumpsquat
		- 11= air
	]]
	
	-- todo: change acceleration
	--  instead of just velocity
	
	local prev_state = player_state
	
	-- jump
	if 
	
	-- dash
	if prev_state==0 and player_vel_x==0 and input_x~=0 then
		player_state=1
		player_dash=20
		
		player_turned = input_x
	end
	
	-- dashing
	if player_state==1 then
		if player_dash > 0 then
			-- dash dance
			if input_x+player_turned==0 then
				player_turned=-player_turned
				player_dash=20
			end
			
			if input_x==0 then
				player_state = 4
			else
				player_vel_x = player_turned * 1.2
				player_dash-=1
			end
		elseif input_x~=0 then
			player_state=2
		else
			player_state=0
		end
	end
	
	-- running
	if player_state==2 then
		if input_x==player_turned then
			player_vel_x = approach(player_vel_x,player_turned * 1.2,1.2)
		else
			player_stopping=20
			player_state=3
		end
	end
	
	-- run stopping
	if player_state==3 then
		if player_vel_x==0 then
			player_state=0
			player_stopping=0
		elseif player_stopping>10 then
			player_vel_x = approach(player_vel_x,0,.08)
			player_stopping-=1
		elseif player_stopping>0 then
			player_vel_x = approach(player_vel_x,0,.4)
			player_stopping-=1
		else
			player_state=0
		end
	end
	
	-- dash stopping
	-- todo: feels awkward
	if player_state==4 then
		-- dash dance
		if input_x+player_turned==0 then
			player_turned=-player_turned
			player_dash=20
			player_state=1
		end
		if player_dash>0 then
			player_vel_x =
				approach(player_vel_x,0,.05)
			player_dash-=1
		else
			player_state=0
		end
	end
	
	-- wait
	if player_state==0 then
		player_vel_x=approach(player_vel_x,0,.2)
	end
	
	-- apply
	plyaer_vel_x+=player_acc_x
	player_x += player_vel_x
	
end

-- approach target velocity with
-- max change of max_delta
-- (ripped straight from celeste2)
function approach(x,target,max_delta)
	return x < target and min(x + max_delta, target) or max(x - max_delta, target)
end

function on_ground(x,y)
	local tile = 0
end

function _draw()
	cls()
	camera(4,4)
	
	-- draw map
	map(0,0,0,0,16,16,1)
	
	-- draw player
	local flip_x = player_turned==-1
	spr(1,player_x,player_y,1,1,flip_x)
	
	--debug
	print(player_state,20,20,7)
	print(player_vel_x,20,28,7)

	camera()
end
-->8
-- input
input_x=0
input_jump=false
input_dash=false
axis_x_turned=false

function update_input()
	-- input_x
	local prev_x=input_x
	if btn(0) then
		if btn(1) then
			-- both pressed, switch directions
			-- only once
			if axis_x_turned then
				input_x = prev_x
			else
				axis_x_turned = true
				input_x = -prev_x
			end
		else
			-- left
			input_x = -1
			axis_x_turned=false
		end
	elseif btn(1) then
		-- right
		input_x = 1
		axis_x_turned=false
	else
		input_x = 0
		axis_x_turned=false
	end
	
	-- input_jump
	input_jump = btn(4)
	
	-- input_dash
end
__gfx__
00000000222222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000288558820000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700288555820000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000288555520000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000288555520000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700288555820000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000288558820000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000222222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777667666667776666766767700000000000000000000000000000000000000000000000000000000000000000000000000000000
77711717711171777717777776006000006760000600606700000000000000000000000000000000000000000000000000000000000000000000000000000000
7771d1d11ddd1d1771d1777776000000000600000000006700000000000000000000000000000000000000000000000000000000000000000000000000000000
771dddddddddddd11ddd117760000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000
71dd7ddddddddddddddddd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71ddddd7ddddddddddd7dd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71ddddddddd7dddddddddd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
771ddddddddddddddddddd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
771ddddddddddddddddddd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
771dddddddddddddddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7771dd7ddddddd7dddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7771ddddddddddddddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
771ddddddd7dddddddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
771dddddddddddddddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71dddddddddddddddddddd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71dd7ddddddddddddddddd1700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71dddddddddd7ddddd7dd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71dd7dddddddddddddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
771dddddddddddddddddd17700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7711dd1dddddddddddd1117700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77771171d11dd1ddd117777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777771177117111777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0080000000000000000000000000000001010103030300000000000000000000010101000000000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000013141500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000013141500000013141500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000001011111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000002021212121212121212122000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000003031313131313131313132000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00020000000002b050300503405036050360503505033050320502e05028050260500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
